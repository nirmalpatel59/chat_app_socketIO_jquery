<html>
<title>My Chat App</title>

<head>
    <link rel="stylesheet" href="lib/bootstrap/dist/css/bootstrap.min.css">
    <script src="socket.io-client/dist/socket.io.js"></script>
    <script src="lib/jquery/dist/jquery.min.js"></script>
    <script src="lib/bootstrap/dist/js/bootstrap.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font: 13px Helvetica, Arial;
        }
        
        .msg-row {
            position: fixed;
            bottom: 20;
            width:100%
        }
/*        
        form input {
            border: 0;
            padding: 10px;
            width: 90%;
            margin-right: .5%;
        }
        
        form button {
            width: 9%;
            background: rgb(130, 224, 255);
            border: none;
            padding: 10px;
        }*/
        
        #messages {
            list-style-type: none;
            margin: 0;
            padding: 0;
        }
        
        #messages li {
            padding: 5px 10px;
        }
        
        #messages li:nth-child(odd) {
            background: #eee;
        }
    </style>
    <script>
        $(function () {
            var socket = io();
            $('#form_btn').on("click",function () {
                socket.emit('chat message', $('#m').val(), { "name": $("#nickname").val() }); $('#m').val(''); return false;
            });
            socket.on('chat message', function (data) {
                var output = [];
                output.push('<li><span><b>'+ data.username+'</b></span> &nbsp; :: &nbsp; <span>'+ data.msg+'</span></li>');
                $('#messages').append(output.join(''));
                // $('#messages').append($('<li>').text(msg));
            });
            socket.on('userList', function (userArray) {
                $("#userslist li").remove();
                console.log(userArray);
                if(userArray.length > 0) {
                    for (var i = 0; i < userArray.length; i++) {
                        // console.log($('*[data-socketId="' + userArray[i].socketId + '"]').length);
                        if($('li').filter(function () { return $(this).data("socketId") == userArray[i].socketId }).length > 0) {
                            console.log("in if");
                        }else {
                            $('#userslist').append($('<li> ').text(userArray[i].username));
                            $('#userslist li:last').data("socketId", userArray[i].socketId);
                        }
                    }
                }
            });
            socket.on('notifications', function(notify_msg) {
                $("#notification").text(notify_msg);
                $("#notification_parent").removeClass("hide");
                setTimeout(function(){
                    $("#notification_parent").addClass("hide");
                },3000);
            });
            socket.on('typingmsg', function (notify_msg) {
                $("#typing_txt").text(notify_msg);
            });
            var typing = false;
            var timeout = undefined;
            var msgComplete = false;

            function timeoutFunction(){
                typing = false;
                // socket.emit();
                if(msgComplete) {
                    socket.emit("cleanTypingMessage", $("#nickname").val());
                }else {
                    socket.emit("noLongerTypingMessage", $("#nickname").val()); setTimeout(function () {
                        socket.emit("cleanTypingMessage", $("#nickname").val());
                    }, 1000);
                }
            }

            function onKeyDownNotEnter(){
                if(typing == false) {
                    typing = true
                    socket.emit("typingMessage", $("#nickname").val());
                    timeout = setTimeout(timeoutFunction, 2000);
                } else {
                    clearTimeout(timeout);
                    timeout = setTimeout(timeoutFunction, 2000);
                }
            }

            $("#m").keydown(function(e) {
                if(e.keyCode == 13) {
                    msgComplete = true;
                    socket.emit('chat message', $('#m').val(), { "name": $("#nickname").val() }); $('#m').val(''); return false;
                }else {
                    onKeyDownNotEnter();
                }
            });

            $('#myModal').modal({ backdrop: 'static', keyboard: false });
                $("#startChat").on("click", function () {
                    if ($("#nickname").val().trim() != "") {
                        $('#myModal').modal("hide");
                        socket.emit("addUser", $("#nickname").val().trim());
                    }
                });
            });
    </script>
</head>

<body>
    <div class="container">
        <div class="row" style="margin:20px;">
            <div class="col-lg-8">
                <div class="row">
                    <div class="col-lg-12">
                        <div class="alert alert-danger hide" id="notification_parent">
                            <strong id="notification"></strong>
                        </div>
                    </div>
                </div>
                <div class="row">
                    <div class="col-lg-12">
                        <ul id="messages"></ul>
                    </div>
                </div>
            </div>
            <div class="col-lg-4">
                <ul id="userslist"></ul>
            </div>
        </div>
        <div class="row msg-row">
            <div class="col-lg-8">
                <!--<form action="">-->

                <input id="m" class="form-control" autocomplete="off">
                <!--</form>-->
            </div>
            <div class="col-lg-4">
                <button class="btn btn-success" id="form_btn">Send</button>
            </div>
            <div class="col-lg-12">
                <span><small id="typing_txt"></small></span>
            </div>
        </div>
    </div>
    <div id="myModal" class="modal fade" role="dialog">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <!--<button type="button" class="close" data-dismiss="modal">&times;</button>-->
                    <h4 class="modal-title">Your Nickname</h4>
                </div>
                <div class="modal-body">
                    <input class="form-control" type="text" id="nickname">
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-default" id="startChat">Start</button>
                </div>
            </div>
        </div>
    </div>
</body>

</html>